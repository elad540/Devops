pipeline {
    agent any
// Every ten minutes in the first half of every hour (three times, perhaps at :04, :14, :24)
   triggers {
      pollSCM '''TZ=Israel
    H(0-59)/10 * * * *'''
    }

   parameters {
   		choice(name: 'action', choices: ['apply', 'destroy'])
   		string defaultValue: '1', description: 'change to create more instances', name: 'amount_of_instance', trim: true
    }

   tools {
      terraform 'Terraform'
      }


   environment {
       AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
       AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
   }

    stages {
        stage ('terraform init') {
        // TODO do only when init is required
              steps {
                dir('terraform-EC2') {
                    sh ('terraform init')
                }
            }
        }
        stage ('terraform Action') {
            steps {
                dir('terraform-EC2') {
                    sh ('terraform ${action} -auto-approve -var "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -var "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}" -var "amount_of_instance=${amount_of_instance}"')
                }
            }
        }
    }
}